# 실전에 활용 가능한 컨테이너 사용법을 익히자

- 실전내용
- 볼륨과 마운트, 바인드 마운트

## 1. 내게 필요한 지식이 무엇인지 정리하기

### 자신의 역할에 따라 알아야할 지식이 달라진다

- 도커를 깊이 공부해야함 : 이미지를 생성자, 서버 / 보안 엔지니어
- 도커를 얕게 공부해야함 : 이미지 사용자, 개발자, 디자이너, PM 등

### 앞으로 설명할 도커 기술

#### 모두 익혀야하는 기술은 **굵게 표시**

- **파일 복사** <sup>호스트<->컨테이너</sup>
- 볼륨 마운트
    - **바인드 마운트** : 컨테이너와 파일 연동, LAMP 스택 필수
    - 볼륨 마운트 : 운영체제와 무관하게 똑같은 방식으로 파일 다루기 가능
- **컨테이너를 이미지로 만들기** : 컨테이너를 다른 서버로 복사하고싶거나 여러개가 필요할 때
    - 서버 엔지니어, 유지보수 담당자
- **컨테이너 개조** : 서버 준비하는 사람에게 필수
    - 사내 시스템을 컨테이너로 전환하게 되었다? **(필수)**
- 도커 허브 로그인 : 자신이 만든 이미지를 공개
- 도커 컴포즈 : 데이터베이스, 애플리케이션 컨테이너를 함께 시작하고 싶거나 환경을 대량 생상하려할 떄
- 쿠버네티스 : 여러대의 서버에서 컨테이너를 실행할 때 사용하는 컨테이너 오케스트레이션 도구
    - **대규모 시스템 운영**이아니라면 거의 사용할 일 없음

## 2. 컨테이너와 호스트 간에 파일 복사하기

- 파일복사는 호스트 <-> 컨테이너 양방향 가능

### 파일 복사

~~~~
## 파일 복사
docker cp [원본 경로] [대상 경로]

## 호스트 -> 컨테이너
docker cp [호스트의 파일] [컨테이너명]:[컨테이너 경로]

## 컨테이너 -> 호스트
docker cp [컨테이너명]:[컨테이너 경로] [호스트 경로]
~~~~

### [실습] 호스트의 파일을 컨테이너 속으로 복사

1. 아파치 컨테이너 생성 and 실행
2. **호스트의 파일을 컨테이너 속으로 복사**
3. 확인

### [실습] 컨테이너의 파일을 호스트로 복사

1. 아파치 컨테이너 생성 and 실행
2. **컨테이너의 파일을 호스트로 복사**
3. 확인

## 3. 볼륨과 마운트

### 볼륨과 마운트

- **data persistency** : 컨테이너가 사용하는 데이터를 컨테이너 외부 <sup>스코리지, 볼륨, 메모리 등</sup>에 두고 사용함
- volume : 스토리지를 분할한 뒤 한 영역
- **mount** : 컨테이너가 외부 데이터를 사용할 수 있도록 연결하는 행위
    - 관례적으로 **'볼륨 마운트'**라고 함

### 스토리지 마운트의 종류

#### 볼륨 마운트

- 임시 파일, 자주쓰지 않지만 지우면 안되는 파일
- **도커 엔진이 관리하는 영역 내**의 볼륨에 마운트

#### 바인드 마운트

- 자주 사용하는 파일
- 도커 엔진 외부의 OS 단 디렉터리에 마운트

#### 볼륨 마운트 vs 바인드 마운트

- 간단한가 복잡한가?
- 호스트 컴퓨터에서 파일을 다룰 것인가?
- 환경의 의존성을 배제해야하는가?

- 볼륨 마운트 <sup>**docker 제작사 권장**</sup>
    - 장점 : 익숙해지면 손쉽게 사용, 운영체제에 의존적이지 않음
    - 단점 : 도커를 경유해서 파일에 접근해야 함, 파일 백업 절차 복잡
        - 파일 백업 절차 : 볼륨을 마운트한 별도의 busy box 컨테이너를 생성면서 .tar 로 압축 백업
- 바인드 마운트
    - 장점 : 기존과 동일한 방식으로 파일 사용 가능, 파일 자주 접근 시 용이

#### 결론 : 파일을 직접 편집할 일이 많으면 바인드 마운트 아니면 볼륨 마운트

### 스토리지 영역을 마운트하는 커맨드

~~~~
## 바인드 마운트
docker run -v [호스트의 디렉터리]:[컨테이너의 디렉터리]

## 볼륨 마운트
docker run -v [볼륨명]:[컨테이너의 디렉터리]
~~~~

#### 스토리지 마운트 절차

1. 스토리지 영역 생성 **(마운트 전에 볼륨을 생성하는 것이 좋음)**
    - 볼륨 마운트라면 마운트와 동시에 볼륨을 생성할 수 있지만 **비추**
2. 컨테이너 생성 and 마운트

### [실습] 바인드 마운트해보기

1. 바인드 마운트할 디렉터리 생성 : 폴더 생성
2. 아파치 컨테이너 생성
3. 초기화면 확인
4. index.html 배치
5. 배치 확인

### [실습] 응용편 = 볼륨 마운트해보기

1. 볼륨 생성
    - 볼륨 생성 위치는 도커가 관리하기 때문에 신경 X
2. 아파치 컨테이너 생성
3. 확인

## 4. 컨테이너로 이미지 만들기

컨테이너를 다른환경에 복제하기 위함으로, 서버 엔지니어의 필수 지식

### 컨테이너로 이미지를 만드는 방법

#### commit 커맨드 이용하기

1. 컨테이너 기반의 이미지 생성 :  commit container
2. 컨테이너 복사 : run image

~~~~
docker commit [컨테이너 이름] [새로운 이미지 이름]
~~~~

#### Dockerfile script 이용

- 이미지를 만드는 스크립트 <sup>재료</sup>

~~~~
docker build -t [생성할 이미지 이름] [재료 폴더 경로]

## Dockerfile script
FROM [이미지 이름]
COPY [원본 경로] [대상 경로]
RUN [리눅스 명렁어]
...
~~~~

### [실습] commit 커맨드로 컨테이너를 이미지로 변환

1. 아파치 컨테이너 생성 and 실행
2. 컨테이너를 이미지로 변환
3. 확인

### [실습] Dockerfile 스크립트로 이미지 만들기

1. Dockfile 스크립트 작성
2. 이미지 빌드
3. 확인

## 5. 컨테이너 개조

### 컨테이너의 개조란?

공식 소프트웨어에 대한 수정이 필요  
설정 파일 수정 등

#### 개조 방법

- 파일 복사 or 마운트
    - 2가지를 혼용해서 개조 진행
- 컨테이너에서 리눅스 명령어 실행
- 컨테이너 조작 시에는 컨테이너에 들어가 bash 명령어로 한다.
- 보통 exec에 전달하여 조작
- **컨테이너 내부에서 할일을 마쳤다면 반드시 컨테이너를 빠져나올 것**
   ~~~~
    exit
    ~~~~

~~~~
## exec 커맨드에 bash 인자 추가
docker exec (옵션) [컨테이너 이름] /bin/bash

## run 커맨드에 bash 인자 추가
docker run --name ....(생략) /bin/bash
~~~~

### 도커의 구조, 도커 엔진을 통해야 하는 명령과 컨테이너 안에서 실행해야하는 명령

#### 도커 엔진을 통한 명령

~~~~
docker ...(생략)
~~~~

- 도커 엔진의 시작 / 종료
- 컨테이너 시작 / 종료
- 컨테이너 안팎의 파일 복사

#### 컨테이너 내부에서 실행하는 명령 <sub>bash</sub>

- 컨테이너 내부 소프트웨어 설치
- 소프트웨어 실행 / 종료
- 소프트웨어 설정 변경
- 파일 작업

#### hsot OS와 컨테이너 OS는 다를 수 있다.

- 따라서 컨테이너 내부 bash 명령어 작성이 리눅스 계열에 의존한다
- 특별한 이유가 없다면 데비안 계열의 컨테이너를 구축하는 것을 추천한다

## 6. 도커 허브 등록 및 로그인

### 이미지는 어디서 내려받는 걸까?

- **docker hub : 이미지 저장소**
- 내가 만든 이미지는 로컬에 이미 이미지를 내려받은 형태로 가지고 있음

### 도터 허브와 도커 레지스트리

- 도커 **레지스트리** : 도커 이미지가 배포되어있는 장소
- 도커 **허브** : 도커 제작사에서 운영하는 공식 도커 레지스트리
- 리포지토리 : 레지스트리의 **구성 단위**

### 태그와 이미지 업로드

~~~~
## 이미지에 태그를 부여한 뒤 복제
docker tag [원래 이미지 이름] [레지스트리주소]/[리포지토리이름]:버전
docker tag apa000ex22 zoozoo.comm/nyapacchi:13

## 레지스트리에 이미지 업로드
docker push [레지스트리주소]/[리포지토리이름]:버전
docer push zoozoo.comm/nyapacchi:13
~~~~

### 레지스트리를 만드는 방법

~~~~
docker run -d -p 5000:5000 registry
~~~~
